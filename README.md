é­”å…½å¼€äº† "å†›å›¢å†ä¸´"ï¼ŒiPhone 7 ä¹Ÿå‘å¸ƒäº†ã€‚ç®—ä¸‹æ¥å¥½ä¹…æ²¡å†™åšå®¢äº†ï¼Œåˆç–äºå­¦ä¹ äº†ã€‚

å…¬å¸é¡¹ç›®çš„æ–°ç‰ˆæœ¬ on the wayã€‚å‰å‡ æ—¥ç»™æ–°ç‰ˆæœ¬åšäº†ä¸ªä¸‹æ‹‰åˆ·æ–°åŠ¨ç”»ï¼Œæ¨¡ä»¿äº† `Enjoy` çš„ä¸‹æ‹‰åˆ·æ–°ã€‚æ•ˆæœå¦‚å›¾

![æ•ˆæœå¦‚å›¾](http://7xie11.com1.z0.glb.clouddn.com/refresh.gif)

æ—¢ç„¶åšäº†ä¸‹æ‹‰åˆ·æ–°ï¼Œå½“é¡µé¢ç¬¬ä¸€è¿›å…¥ï¼Œä¹Ÿåº”å½“æœ‰ä¸ªé¢„åŠ è½½çš„åŠ¨ç”»ã€‚è¿™æ ·å½“æ•°æ®åŠ è½½å®Œæˆï¼Œå°†è¿™ä¸ªé¢„åŠ è½½åŠ¨ç”»éšè—æ‰ï¼Œç”¨æˆ·ä½“éªŒä¼šå¥½å¾ˆå¤šã€‚äºæ˜¯åˆæäº†ä¸€ä¸ªé¢„åŠ è½½åŠ¨ç”»ï¼Œå¦‚ä¸‹

![é¢„åŠ è½½](http://7xie11.com1.z0.glb.clouddn.com/preload.gif)

## åŠ¨ç”»å®ç°ç®€å•æ€»ç»“

### ä¸‹æ‹‰åˆ·æ–°åŠ¨ç”»

ä¸‹æ‹‰åˆ·æ–°çš„åŠ¨ç”»ï¼Œåœ¨å¤šæ¬¡è§‚å¯Ÿäº† `Enjoy` çš„åŠ¨ç”»ä¹‹åï¼Œèµ·åˆè®¤ä¸ºå¯ä»¥é€šè¿‡ä¿®æ”¹ `CAShapeLayer` çš„ `lineWidth` å±æ€§æ¥å®ç°åœ†ç¯ç”±ç²—å˜ç»†çš„æ•ˆæœã€‚åœ¨ç¬¬ä¸€æ¬¡å°è¯•äº†ä½¿ç”¨è¯¥æ–¹æ³•åï¼Œå‘ç°æ•ˆæœå¹¶ä¸ç†æƒ³ï¼Œè€Œä¸”åœ¨å¿«é€Ÿä¸Šä¸‹æ‹–åŠ¨ `table view` çš„æƒ…å†µä¸‹ï¼Œåœ†ä¼šå‡ºç°æ¼‚ç§»çš„æƒ…å†µã€‚

ç”±äºåœ†ç”±å°å˜å¤§çš„æ•ˆæœï¼Œå·²ç»å®Œæˆäº†ï¼Œæƒ³åˆ°äº†ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ï¼Œåœ¨åŸæœ‰çš„åœ†ä¸Šé¢æ·»åŠ ä¸€ä¸ª `view`ï¼ŒæŠŠè¿™ä¸ª `view` çš„èƒŒæ™¯è‰²è®¾ç½®æˆä¸‹æ‹‰åŒºåŸŸèƒŒæ™¯è‰²ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ç§åœ†ç¯å˜åŒ–çš„å‡è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![ç¤ºæ„](http://7xie11.com1.z0.glb.clouddn.com/refresh.png)

é€šè¿‡ Reveal ç›´è§‚çš„çœ‹ä¸€ä¸‹

![Reveal](http://7xie11.com1.z0.glb.clouddn.com/reveal.png)

æ ¹æ® `table view` ä¸‹æ‹‰çš„è·ç¦»è®¡ç®—å‡ºåº•å±‚åœ†å’Œä¸Šå±‚åœ†çš„ sizeã€‚å®æ—¶é‡ç»˜ layer çš„ path çš„å°±è¡Œäº†

### é¢„åŠ è½½åŠ¨ç”»

é¢„åŠ è½½åŠ¨ç”»ï¼Œæ‹†è§£ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªä¸Šä¸‹è·³åŠ¨çš„å›¾ç‰‡åŠ ä¸Šä¸€ä¸ªå®½åº¦éšè·³åŠ¨çŠ¶æ€å˜åŒ–çš„é˜´å½±å›¾ç‰‡ã€‚

ä½¿ç”¨ `CABasicAnimation` åˆ¶ä½œä¸€ç§çŠ¶æ€çš„åŠ¨ç”»ï¼Œé€šè¿‡ `CAAnimationGroup` è¿›è¡ŒåŠ¨ç”»çš„ç»„è£…ã€‚

ä¾‹å¦‚ä¸Šä¸‹è·³åŠ¨åŠ¨ç”»çš„å®ç°ä»£ç ï¼Œå¦‚ä¸‹

	let upAnimation = CABasicAnimation(keyPath: "position.y")
	upAnimation.fromValue = self.markedImageView!.center.y
	upAnimation.toValue = self.markedImageView!.center.y - JESRefreshIconConstants.maxOffsetY
	upAnimation.duration = JESRefreshIconConstants.jumpDuration
	upAnimation.beginTime = 0
	upAnimation.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseOut)
        
	let downAnimation = CABasicAnimation(keyPath: "position.y")
	downAnimation.fromValue = self.markedImageView!.center.y - JESRefreshIconConstants.maxOffsetY
	downAnimation.toValue = self.markedImageView!.center.y
	downAnimation.duration = JESRefreshIconConstants.downDuration
	downAnimation.beginTime = JESRefreshIconConstants.jumpDuration
	downAnimation.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseIn)
        
	let animationGroup = CAAnimationGroup()
	animationGroup.animations = [upAnimation, downAnimation]
	animationGroup.duration = JESRefreshIconConstants.jumpDuration + JESRefreshIconConstants.downDuration
	animationGroup.beginTime = self.state.animationBeginTime()
	animationGroup.fillMode = kCAFillModeForwards
	animationGroup.repeatCount = Float.infinity
	animationGroup.removedOnCompletion = false
	animationGroup.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionLinear)
        
	self.markedImageView!.layer.addAnimation(animationGroup, forKey: "image.animation.key")

> å¦‚æœåŠ¨ç”»åœ¨ App é€€è‡³åå°åœ¨è¿›å…¥å‰å°ä¹‹ååŠ¨ç”»åœæ­¢äº†ï¼Œè¯·å°† `removedOnCompletion` è®¾ç½®æˆ false

é˜´å½±çš„åŠ¨ç”»ä¸ä¸Šä¸‹è·³åŠ¨åŠ¨ç”»ç±»ä¼¼ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚

### åŠ¨ç”»å®Œæˆä¹‹åå¯¹äºä½¿ç”¨çš„æ€è€ƒ

å®Œæˆäº†ç†æƒ³çš„æ•ˆæœï¼Œå¦‚ä½•ä½¿ç”¨ï¼Œå°±è¯¥å¥½å¥½è€ƒè™‘ä¸‹äº†ã€‚åœ¨æ¯ä¸€ä¸ªéœ€è¦ç”¨åˆ°çš„ VC é‡Œå†™ä»£ç ï¼Ÿè¿™ææ€•å¹¶ä¸è®©äººæ»¡æ„ï¼Œé‡å¤å†™å¦‚æ­¤å¤šçš„ä»£ç ï¼Œç¡®å®è®©äººå¿ƒé‡Œæœ‰äº›è®¸çš„åˆ«æ‰­ã€‚æƒ³åˆ°äº†ä¹‹å‰çœ‹åˆ°çš„ `SwiftGG` ç¿»è¯‘çš„ä¸€ç¯‡æ–‡ç« ï¼Œ[ç”¨ Swift ç¼–å†™é¢å‘åè®®çš„è§†å›¾](http://swift.gg/2016/06/01/protocol-oriented-views-in-swift/)

ä¸¾ä¸€åä¸‰ï¼Œä¸º table view ç»Ÿä¸€æ·»åŠ ä¸‹æ‹‰åˆ·æ–°äº‹ä»¶ï¼ŒåŸç†æ–‡ç« ä¸­æœ‰è®²ï¼Œçœ‹ä»£ç 

	typealias RefreshHandler = () -> Void

	protocol Refreshable { }

	extension Refreshable where Self: UIScrollView {
    
		func refresh(withActionHandler actionHandler: RefreshHandler) {
			let loadingView = JESPullToRefreshLoadingViewCircle(fillColor: UIColor(red: 224/255.0, green: 231/255.0, blue: 235/255.0, alpha: 1.0))
			loadingView.tintColor = UIColor.whiteColor()
        	self.jes_addPullToRefreshWithActionHandler(actionHandler, loadingView: loadingView, logoImage: "refresh_logo")
        	self.jes_setPullToRefreshFillColor(UIColor(red: 224/255.0, green: 231/255.0, blue: 235/255.0, alpha: 1.0))
        	self.jes_setPullToRefreshBackgroundColor(self.backgroundColor!)
    	}  
	}

	class JESPullToRefreshTableView: UITableView, Refreshable {
    
	}

è¿™æ ·è®©éœ€è¦å®ç°ä¸‹æ‹‰åˆ·æ–°çš„ table view ç»§æ‰¿èµ„ `JESPullToRefreshTableView` é€šè¿‡ 

	tableView.refresh {
		// ä¸‹æ‹‰åˆ·æ–°åæ“ä½œ
	}
	
å°±å¯ä»¥å®ç°ä¸‹æ‹‰åˆ·æ–°æ“ä½œã€‚

é¢„åŠ è½½çš„åŠ¨ç”»ï¼Œåˆ™é€‰æ‹©ä½¿ç”¨ `UIViewController` çš„ extension æ¥å®ç°ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªç§æœ‰çš„èƒŒæ™¯ view ç”¨æ¥è¦†ç›–åŸè§†å›¾ï¼Œæ”¾ç½®åŠ¨ç”»è§†å›¾
    
    private var loadingBgView: UIView? {
        get {
            return objc_getAssociatedObject(self, &Constants.loadingKey) as? UIView
        }
        set {
            objc_setAssociatedObject(self, &Constants.loadingKey, newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_RETAIN_NONATOMIC)
        }
    }
    
    public func showPreLoading(backgroundColor: UIColor = UIColor.whiteColor()) {
        if self.loadingBgView == nil {
            let loadingBgView = UIView(frame: self.view.bounds)
            self.loadingBgView = loadingBgView
            loadingBgView.backgroundColor = backgroundColor
            self.view.addSubview(loadingBgView)
            
            let loadingView = JESRefreshView(frame: CGRect(x: 0, y: 0, width: Constants.loadingWidth, height: Constants.loadingHeight))
            loadingView.center = CGPoint(x: self.view.bounds.width / 2.0, y: (self.view.bounds.height - Constants.loadingHeight) / 2.0)
            
            loadingBgView.addSubview(loadingView)
            
            loadingView.animate()
        }
    }
    
    public func dismissPreLoading() {
        // Remove Animation and background view
        UIView.animateWithDuration(0.375, animations: {
            self.loadingBgView?.alpha = 0.0
        }) { _ in
            self.loadingBgView?.removeFromSuperview()
            self.loadingBgView = nil
        }
    }

è¿™æ ·å°±å®ç°äº†ä¸ºæ¯ä¸€ä¸ª vc æ·»åŠ é¢„åŠ è½½åŠ¨ç”»äº†ã€‚

# ğŸ‰ æ›´åŠ  Swift çš„ä½¿ç”¨

å›½åº†èŠ‚å‰çœ‹åˆ°äº† [é›é’Kçš„ä¸€ç¯‡æ–‡ç« ](http://blog.dianqk.org/2016/08/10/better-swifty-framework-namespace/)ï¼Œäºæ˜¯å›åˆ°RxSwift é¡¹ç›®ä¸‹æŸ¥çœ‹äº†è¿™ä¸ª [issue826](https://github.com/ReactiveX/RxSwift/issues/826) å¾ˆæœ‰æ„æ€ï¼Œissue å†…å®¹ä¸åœ¨æ­¤èµ˜è¿°ã€‚è¿™ä¹Ÿè§£å†³äº†æˆ‘åœ¨ä¹‹å‰é€‚é… Swift 3 çš„æ—¶å€™ï¼Œå¯¹è¯¸å¦‚ `Kingfisher`/`SnapKit`/`RxSwift`ï¼Œç»Ÿç»Ÿå°† `xxx_xxxx` è¿™æ ·çš„ä»£ç å½¢å¼ä¿®æ”¹æˆäº† `xxx.xxxx` çš„ç–‘æƒ‘ã€‚

ä¹‹å‰çš„ä¸€ç¯‡åšå®¢ [ä»ä¸€ä¸ªé¢„åŠ è½½åŠ¨ç”»æƒ³èµ·](http://shiweicn.github.io/2016/09/08/thinking-after-animation/) å†™äº†ä½¿ç”¨é¢å‘åè®®ç¼–ç¨‹å®ç°è§†å›¾ã€‚åœ¨æ–‡ç« ä¸­ï¼Œä½¿ç”¨äº†é¢å‘åè®®çš„æ–¹å¼ï¼Œå°†åˆ·æ–°å’Œé¢„åŠ è½½åŠ¨ç”»è¿›è¡Œäº†å°è£…ã€‚ä¸è¿‡è¿™æ ·çš„åšæ³•ï¼Œéœ€è¦è®¾ç½®éœ€è¦å®ç°åˆ·æ–°çš„ tableView ç»Ÿç»Ÿç»§æ‰¿è‡ªè®¾å®šå¥½çš„çˆ¶ç±»ã€‚èƒ½ä¸èƒ½æŒ‰ç…§å‰æ–‡ä¸­çš„æ–¹å¼è¿›è¡Œæ›´å¥½çš„ä¿®æ”¹å‘¢ï¼Ÿ

> æ¥è¯•è¯•å§ï¼

# å„ä¸ªå‡»ç ´

## åˆ·æ–°

ä½¿ç”¨ struct æ¥å°è£…ä¸€ä¸‹ï¼Œå°±ç”¨ `Refresh` å§ã€‚

	public struct Refresh<Base: Any> {
		public let base: Base
		public init(_ base: Base) {
			self.base = base
		}
	}

æ·»åŠ æ‰©å±•å±æ€§

	public extension NSObjectProtocol {
		public var refresh: Refresh<Self> {
			return Refresh(self)
		}
	}

ä¸º `Refresh` æ·»åŠ æƒ³è¦çš„ `extension`

	public extension Refresh where Base: UIScrollView {
    
		// MARK: - Methods (public)
		public func handler(_ handler: @escaping () -> Void) {
			let loadingView = JESPullToRefreshLoadingViewCircle(fillColor: UIColor(red: 224/255.0, green: 231/255.0, blue: 235/255.0, alpha: 1.0))
			loadingView.tintColor = UIColor.white
			base.jes_addPullToRefreshWithActionHandler(handler, loadingView: loadingView, logoImage: "refresh_logo")
			base.jes_setPullToRefreshFillColor(UIColor(red: 224/255.0, green: 231/255.0, blue: 235/255.0, alpha: 1.0))
			base.jes_setPullToRefreshBackgroundColor(base.backgroundColor!)
		}
    
		public func remove() {
			base.jes_removePullToRefresh()
		}
    
		public func stop() {
			base.jes_stopLoading()
		}    
	}

è¿™é‡Œå°†åŸå…ˆçš„æ–¹æ³•ç”± `public` ä¿®æ”¹ä¸º `fileprivate` åœ¨å¤–éƒ¨ä¸å…è®¸è°ƒç”¨ï¼Œä½¿ç”¨ `base.` å¯ä»¥è°ƒç”¨åŸå…ˆçš„æ–¹æ³•ã€‚

è¿™æ ·ï¼Œåœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œä¸å†éœ€è¦è®¾ç½®ä¿®æ”¹ `table view` æˆ–è€… `collection view` ç»§æ‰¿è‡ªé¢„å…ˆè®¾å®šå¥½çš„çˆ¶ç±»ï¼Œè€Œç›´æ¥ä½¿ç”¨è¯¸å¦‚

	tableView.refresh.handler { 
		DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + Double(Int64(2.5 * Double(NSEC_PER_SEC))) / Double(NSEC_PER_SEC), execute: {
			self.tableView.refresh.stop()
		})
	}
	
å»é™¤åˆ·æ–°åˆ™éœ€è¦åœ¨ `deinit()` æ–¹æ³•ä¸­è°ƒç”¨ `tableView.refresh.remove()`

## é¢„åŠ è½½åŠ¨ç”»

ä½¿ç”¨ç±»ä¼¼çš„æ–¹æ³•ï¼Œé¦–å…ˆä½¿ç”¨ struct å°è£…ä¸‹é¢„åŠ è½½ç±»ï¼Œå°±å«å®ƒ `Preloading`ã€‚

	public struct Preloading<Base: Any> {
		public let base: Base
		public init(_ base: Base) {
			self.base = base
		}
	}

æ·»åŠ æ‰©å±•å±æ€§

	public extension NSObjectProtocol {
		public var preloading: Preloading<Self> {
			return Preloading(self)
		}
	}
	
æ·»åŠ æ–°æ–¹æ³•è°ƒç”¨åŸå…ˆæ–¹æ³•	

	public extension Preloading where Base: UIViewController 	{
		public func show(withBackgroundColor color: UIColor = UIColor.white) {
			base.showPreLoading(color)
		}
    
		public func dismiss() {
			base.dismissPreLoading()
		}
	}

åœ¨è§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œè°ƒç”¨
	
	self.preloading.show()
	
	self.preloading.dismiss()
	
ğŸ‰ Perfectï¼ 

